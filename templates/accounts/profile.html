{% extends 'base/dashboard.html' %}

{% block title %}Mon Profil - Famille KANYAMUKENGE{% endblock %}
{% block page_title %}Mon Profil{% endblock %}

{% block dashboard_content %}
<div class="max-w-4xl mx-auto">
    
    <!-- Header avec avatar -->
    <div class="bg-white rounded-xl shadow-sm border border-brand-border p-6 mb-8">
        <div class="flex items-center gap-6">
            <div class="w-24 h-24 bg-gradient-to-br from-brand-primary to-green-700 rounded-full flex items-center justify-center text-white text-3xl font-serif font-bold">
                {{ user.first_name.0|default:'U' }}{{ user.last_name.0|default:'U' }}
            </div>
            <div class="flex-1">
                <h1 class="font-serif text-2xl font-bold text-gray-900">
                    {{ user.get_full_name|default:user.username }}
                </h1>
                <p class="text-gray-600 flex items-center gap-2 mt-1">
                    <i data-feather="shield" class="w-4 h-4"></i>
                    {{ user.get_role_display }}
                </p>
                <p class="text-gray-500 text-sm flex items-center gap-2 mt-1">
                    <i data-feather="calendar" class="w-4 h-4"></i>
                    Membre depuis le {{ user.date_joined|date:"d F Y" }}
                </p>
            </div>
            <div class="text-right">
                <div class="flex items-center gap-2 mb-2">
                    <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                    <span class="text-sm text-green-600 font-medium">Compte actif</span>
                </div>
                {% if user.is_verified %}
                <div class="flex items-center gap-2">
                    <i data-feather="check-circle" class="w-4 h-4 text-green-500"></i>
                    <span class="text-sm text-gray-600">Email vérifié</span>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <!-- Formulaire de modification du profil -->
        <div class="lg:col-span-2">
            <div class="bg-white rounded-xl shadow-sm border border-brand-border p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="font-serif text-xl font-bold text-gray-900">Informations personnelles</h2>
                    <button onclick="toggleEditMode()" id="editButton" class="text-brand-accent hover:text-brand-primary text-sm font-medium flex items-center gap-1">
                        <i data-feather="edit-2" class="w-4 h-4"></i>
                        Modifier
                    </button>
                </div>

                <!-- FIXED: Proper form with styled input fields -->
                <form method="post" id="profileForm" style="display: none;">
                    {% csrf_token %}
                    
                    <div class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- First Name -->
                            <div>
                                <label for="id_first_name" class="block text-sm font-medium text-gray-700 mb-2">
                                    Prénom
                                </label>
                                <input type="text" id="id_first_name" name="first_name" 
                                       value="{{ user.first_name|default:'' }}"
                                       class="w-full px-4 py-2 border border-brand-border rounded-lg focus:ring-2 focus:ring-brand-primary focus:border-transparent">
                            </div>

                            <!-- Last Name -->
                            <div>
                                <label for="id_last_name" class="block text-sm font-medium text-gray-700 mb-2">
                                    Nom de famille
                                </label>
                                <input type="text" id="id_last_name" name="last_name" 
                                       value="{{ user.last_name|default:'' }}"
                                       class="w-full px-4 py-2 border border-brand-border rounded-lg focus:ring-2 focus:ring-brand-primary focus:border-transparent">
                            </div>
                        </div>

                        <!-- Email -->
                        <div>
                            <label for="id_email" class="block text-sm font-medium text-gray-700 mb-2">
                                Adresse email
                            </label>
                            <input type="email" id="id_email" name="email" 
                                   value="{{ user.email|default:'' }}"
                                   class="w-full px-4 py-2 border border-brand-border rounded-lg focus:ring-2 focus:ring-brand-primary focus:border-transparent">
                        </div>

                        <!-- Phone -->
                        <div>
                            <label for="id_phone_number" class="block text-sm font-medium text-gray-700 mb-2">
                                Numéro de téléphone
                            </label>
                            <input type="tel" id="id_phone_number" name="phone_number" 
                                   value="{{ user.phone_number|default:'' }}"
                                   class="w-full px-4 py-2 border border-brand-border rounded-lg focus:ring-2 focus:ring-brand-primary focus:border-transparent"
                                   placeholder="+243 XXX XXX XXX">
                        </div>

                        <!-- Action buttons -->
                        <div class="flex gap-4 pt-4 border-t border-gray-200">
                            <button type="submit" class="bg-brand-primary text-white px-6 py-2 rounded-lg font-medium hover:bg-green-800 transition flex items-center gap-2">
                                <i data-feather="save" class="w-4 h-4"></i>
                                Enregistrer
                            </button>
                            <button type="button" onclick="toggleEditMode()" class="bg-gray-100 text-gray-700 px-6 py-2 rounded-lg font-medium hover:bg-gray-200 transition">
                                Annuler
                            </button>
                        </div>
                    </div>
                </form>

                <!-- View Mode -->
                <div id="profileView">
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-500 mb-1">Prénom</label>
                                <p class="text-gray-900">{{ user.first_name|default:"Non renseigné" }}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-500 mb-1">Nom de famille</label>
                                <p class="text-gray-900">{{ user.last_name|default:"Non renseigné" }}</p>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-500 mb-1">Adresse email</label>
                            <p class="text-gray-900">{{ user.email }}</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-500 mb-1">Numéro de téléphone</label>
                            <p class="text-gray-900">{{ user.phone_number|default:"Non renseigné" }}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- FIXED: Working Change Password Section -->
            <div class="bg-white rounded-xl shadow-sm border border-brand-border p-6 mt-6">
                <h3 class="font-serif text-lg font-bold text-gray-900 mb-4">Sécurité du compte</h3>
                
                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                    <div>
                        <p class="font-medium text-gray-900">Mot de passe</p>
                        <p class="text-sm text-gray-500">Dernière modification : {{ user.last_login|date:"d F Y"|default:"Jamais" }}</p>
                    </div>
                    <button onclick="togglePasswordChangeForm()" id="passwordChangeButton" class="text-brand-accent hover:text-brand-primary text-sm font-medium">
                        Modifier le mot de passe
                    </button>
                </div>
                
                <!-- Password Change Form -->
                <div id="passwordChangeForm" class="mt-4 hidden">
                    <form method="post" action="{% url 'accounts:change_password' %}">
                        {% csrf_token %}
                        <div class="space-y-4">
                            <div>
                                <label for="old_password" class="block text-sm font-medium text-gray-700 mb-2">
                                    Mot de passe actuel
                                </label>
                                <input type="password" id="old_password" name="old_password" required
                                       class="w-full px-4 py-2 border border-brand-border rounded-lg focus:ring-2 focus:ring-brand-primary focus:border-transparent">
                            </div>
                            
                            <div>
                                <label for="new_password1" class="block text-sm font-medium text-gray-700 mb-2">
                                    Nouveau mot de passe
                                </label>
                                <input type="password" id="new_password1" name="new_password1" required
                                       class="w-full px-4 py-2 border border-brand-border rounded-lg focus:ring-2 focus:ring-brand-primary focus:border-transparent">
                            </div>
                            
                            <div>
                                <label for="new_password2" class="block text-sm font-medium text-gray-700 mb-2">
                                    Confirmer le nouveau mot de passe
                                </label>
                                <input type="password" id="new_password2" name="new_password2" required
                                       class="w-full px-4 py-2 border border-brand-border rounded-lg focus:ring-2 focus:ring-brand-primary focus:border-transparent">
                            </div>
                            
                            <div class="flex gap-4 pt-4">
                                <button type="submit" class="bg-brand-primary text-white px-6 py-2 rounded-lg font-medium hover:bg-green-800 transition flex items-center gap-2">
                                    <i data-feather="lock" class="w-4 h-4"></i>
                                    Changer le mot de passe
                                </button>
                                <button type="button" onclick="togglePasswordChangeForm()" class="bg-gray-100 text-gray-700 px-6 py-2 rounded-lg font-medium hover:bg-gray-200 transition">
                                    Annuler
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Sidebar avec informations et statistiques -->
        <div class="space-y-6">
            
            <!-- Permissions -->
            <div class="bg-white rounded-xl shadow-sm border border-brand-border p-6">
                <h3 class="font-serif text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
                    <i data-feather="key" class="w-5 h-5 text-gray-400"></i>
                    Permissions
                </h3>
                
                <div class="space-y-3">
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600">Ajouter des enfants</span>
                        <div class="flex items-center gap-2">
                            {% if user.can_add_children %}
                                <i data-feather="check" class="w-4 h-4 text-green-500"></i>
                                <span class="text-sm text-green-600">Autorisé</span>
                            {% else %}
                                <i data-feather="x" class="w-4 h-4 text-red-500"></i>
                                <span class="text-sm text-red-600">Non autorisé</span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600">Modifier ses infos</span>
                        <div class="flex items-center gap-2">
                            {% if user.can_modify_own_info %}
                                <i data-feather="check" class="w-4 h-4 text-green-500"></i>
                                <span class="text-sm text-green-600">Autorisé</span>
                            {% else %}
                                <i data-feather="x" class="w-4 h-4 text-red-500"></i>
                                <span class="text-sm text-red-600">Non autorisé</span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600">Voir infos privées</span>
                        <div class="flex items-center gap-2">
                            {% if user.can_view_private_info %}
                                <i data-feather="check" class="w-4 h-4 text-green-500"></i>
                                <span class="text-sm text-green-600">Autorisé</span>
                            {% else %}
                                <i data-feather="x" class="w-4 h-4 text-red-500"></i>
                                <span class="text-sm text-red-600">Non autorisé</span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600">Exporter données</span>
                        <div class="flex items-center gap-2">
                            {% if user.can_export_data %}
                                <i data-feather="check" class="w-4 h-4 text-green-500"></i>
                                <span class="text-sm text-green-600">Autorisé</span>
                            {% else %}
                                <i data-feather="x" class="w-4 h-4 text-red-500"></i>
                                <span class="text-sm text-red-600">Non autorisé</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- FIXED: Real contribution statistics -->
            <div class="bg-white rounded-xl shadow-sm border border-brand-border p-6">
                <h3 class="font-serif text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
                    <i data-feather="activity" class="w-5 h-5 text-gray-400"></i>
                    Mes contributions
                </h3>
                
                <div class="space-y-4">
                    <div class="text-center">
                        <div class="text-2xl font-serif font-bold text-brand-primary">
                            {{ stats.people_added|default:0 }}
                        </div>
                        <p class="text-sm text-gray-600">Personnes ajoutées</p>
                    </div>
                    
                    <div class="text-center">
                        <div class="text-2xl font-serif font-bold text-brand-primary">
                            {{ stats.modifications_proposed|default:0 }}
                        </div>
                        <p class="text-sm text-gray-600">Modifications proposées</p>
                    </div>
                    
                    <div class="text-center">
                        <div class="text-2xl font-serif font-bold text-brand-primary">
                            {{ stats.partnerships_created|default:0 }}
                        </div>
                        <p class="text-sm text-gray-600">Relations créées</p>
                    </div>
                </div>
                
                <div class="mt-4 pt-4 border-t border-gray-200">
                    <div class="text-xs text-gray-500 mb-2">
                        Membre depuis {{ user.date_joined|timesince }}
                    </div>
                    {% if user.role == 'admin' %}
                    <a href="{% url 'genealogy:audit_log' %}" class="text-sm text-brand-accent hover:text-brand-primary flex items-center gap-1">
                        <i data-feather="clock" class="w-4 h-4"></i>
                        Voir mon historique
                    </a>
                    {% endif %}
                </div>
            </div>

            <!-- Actions rapides -->
            <div class="bg-white rounded-xl shadow-sm border border-brand-border p-6">
                <h3 class="font-serif text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
                    <i data-feather="zap" class="w-5 h-5 text-gray-400"></i>
                    Actions rapides
                </h3>
                
                <div class="space-y-2">
                    {% if user.can_add_children %}
                    <a href="{% url 'genealogy:person_create' %}" class="block p-3 rounded-lg hover:bg-gray-50 transition text-sm flex items-center gap-2">
                        <i data-feather="user-plus" class="w-4 h-4 text-brand-accent"></i>
                        Ajouter un membre
                    </a>
                    {% endif %}
                    
                    <a href="{% url 'genealogy:family_tree' %}" class="block p-3 rounded-lg hover:bg-gray-50 transition text-sm flex items-center gap-2">
                        <i data-feather="share-2" class="w-4 h-4 text-brand-accent"></i>
                        Voir l'arbre
                    </a>
                    
                    <a href="{% url 'genealogy:search' %}" class="block p-3 rounded-lg hover:bg-gray-50 transition text-sm flex items-center gap-2">
                        <i data-feather="search" class="w-4 h-4 text-brand-accent"></i>
                        Rechercher
                    </a>
                    
                    {% if user.can_export_data %}
                    <a href="#" onclick="showGedcomModal()" class="block p-3 rounded-lg hover:bg-gray-50 transition text-sm flex items-center gap-2">
                        <i data-feather="download" class="w-4 h-4 text-brand-accent"></i>
                        Exporter GEDCOM
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function toggleEditMode() {
        const form = document.getElementById('profileForm');
        const view = document.getElementById('profileView');
        const button = document.getElementById('editButton');
        
        if (form.style.display === 'none') {
            // Switch to edit mode
            form.style.display = 'block';
            view.style.display = 'none';
            button.innerHTML = '<i data-feather="x" class="w-4 h-4"></i> Annuler';
            feather.replace();
        } else {
            // Switch to view mode
            form.style.display = 'none';
            view.style.display = 'block';
            button.innerHTML = '<i data-feather="edit-2" class="w-4 h-4"></i> Modifier';
            feather.replace();
        }
    }
    
    function togglePasswordChangeForm() {
        const form = document.getElementById('passwordChangeForm');
        const button = document.getElementById('passwordChangeButton');
        
        if (form.classList.contains('hidden')) {
            form.classList.remove('hidden');
            button.textContent = 'Annuler';
        } else {
            form.classList.add('hidden');
            button.textContent = 'Modifier le mot de passe';
        }
    }

    // Initialize feather icons
    document.addEventListener('DOMContentLoaded', function() {
        feather.replace();
    });
</script>
{% endblock %}