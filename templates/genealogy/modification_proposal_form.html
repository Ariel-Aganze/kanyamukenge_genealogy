{% extends 'base/dashboard.html' %}

{% block title %}Proposer une modification - Famille KANYAMUKENGE{% endblock %}
{% block page_title %}Proposer une modification{% endblock %}

{% block dashboard_content %}
<div class="max-w-4xl mx-auto">

    <!-- Breadcrumb -->
    <nav class="flex items-center gap-2 text-sm text-gray-500 mb-6">
        <a href="{% url 'genealogy:dashboard' %}" class="hover:text-brand-primary transition">Tableau de bord</a>
        <i data-feather="chevron-right" class="w-4 h-4"></i>
        <a href="{% url 'genealogy:person_detail' person.id %}" class="hover:text-brand-primary transition">{{ person.get_full_name }}</a>
        <i data-feather="chevron-right" class="w-4 h-4"></i>
        <span class="text-brand-primary">Proposer une modification</span>
    </nav>

    <!-- Header -->
    <div class="bg-white rounded-xl border border-brand-border shadow-sm p-6 mb-8">
        <div class="flex items-center gap-4">
            <div class="w-16 h-16 bg-gradient-to-br from-yellow-500 to-yellow-600 rounded-full flex items-center justify-center">
                <i data-feather="edit-3" class="w-8 h-8 text-white"></i>
            </div>
            <div class="flex-1">
                <h1 class="font-serif text-2xl font-bold text-brand-primary">Proposer une modification</h1>
                <p class="text-gray-600">Suggérez une correction ou une amélioration pour <strong>{{ person.get_full_name }}</strong></p>
            </div>
            <!-- Personne concernée -->
            <div class="text-right">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br 
                        {% if person.gender == 'M' %}from-blue-500 to-blue-600{% elif person.gender == 'F' %}from-pink-500 to-pink-600{% else %}from-gray-500 to-gray-600{% endif %} 
                        flex items-center justify-center text-white font-bold">
                        {{ person.first_name.0 }}{{ person.last_name.0 }}
                    </div>
                    <div>
                        <p class="font-medium text-gray-900">{{ person.get_full_name }}</p>
                        {% if person.birth_date %}
                        <p class="text-xs text-gray-500">{{ person.birth_date|date:"Y" }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Information importante -->
    <div class="bg-blue-50 border border-blue-200 rounded-xl p-6 mb-8">
        <div class="flex items-start gap-3">
            <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center flex-shrink-0 mt-0.5">
                <i data-feather="info" class="w-4 h-4 text-blue-600"></i>
            </div>
            <div>
                <h3 class="font-semibold text-blue-900 mb-2">Comment ça fonctionne ?</h3>
                <div class="text-sm text-blue-800 space-y-2">
                    <p>• Vous proposez une modification qui sera examinée par les administrateurs</p>
                    <p>• Seules les personnes autorisées peuvent modifier directement les informations</p>
                    <p>• Vos suggestions nous aident à maintenir la qualité de l'arbre généalogique</p>
                    <p>• Une notification sera envoyée au propriétaire de la fiche</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Formulaire -->
    <div class="bg-white rounded-xl border border-brand-border shadow-sm">
        <div class="px-6 py-4 border-b border-gray-100">
            <h2 class="font-serif text-xl font-bold text-gray-900">Détails de la modification</h2>
        </div>
        
        <form method="post" class="p-6" id="proposalForm">
            {% csrf_token %}
            
            <!-- Champ à modifier -->
            <div class="space-y-6 mb-8">
                <h3 class="font-serif text-lg font-semibold text-gray-900 flex items-center gap-2 pb-2 border-b border-gray-200">
                    <i data-feather="target" class="w-5 h-5 text-brand-primary"></i>
                    Champ à modifier
                </h3>
                
                <div>
                    <label for="{{ form.field_name.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                        Quelle information souhaitez-vous modifier ? *
                    </label>
                    {{ form.field_name }}
                    {% if form.field_name.errors %}
                        <div class="mt-1 text-sm text-red-600 flex items-center gap-1">
                            <i data-feather="alert-circle" class="w-4 h-4"></i>
                            {{ form.field_name.errors.0 }}
                        </div>
                    {% endif %}
                    
                    <!-- Affichage de la valeur actuelle -->
                    <div class="mt-3 p-4 bg-stone-50 border border-stone-200 rounded-lg">
                        <h4 class="text-sm font-medium text-gray-700 mb-2">Valeur actuelle :</h4>
                        <div class="text-sm text-gray-900" id="current-value">
                            <em class="text-gray-400">Sélectionnez un champ pour voir la valeur actuelle</em>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Nouvelle valeur -->
            <div class="space-y-6 mb-8">
                <h3 class="font-serif text-lg font-semibold text-gray-900 flex items-center gap-2 pb-2 border-b border-gray-200">
                    <i data-feather="edit-2" class="w-5 h-5 text-brand-primary"></i>
                    Nouvelle valeur
                </h3>
                
                <div>
                    <label for="{{ form.new_value.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                        Nouvelle valeur proposée *
                    </label>
                    {{ form.new_value }}
                    {% if form.new_value.errors %}
                        <div class="mt-1 text-sm text-red-600 flex items-center gap-1">
                            <i data-feather="alert-circle" class="w-4 h-4"></i>
                            {{ form.new_value.errors.0 }}
                        </div>
                    {% endif %}
                    <p class="mt-1 text-xs text-gray-500">
                        Saisissez la nouvelle valeur que vous proposez pour ce champ.
                    </p>
                    
                    <!-- Aide contextuelle selon le champ -->
                    <div id="field-help" class="hidden mt-3 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <div class="text-sm text-yellow-800">
                            <!-- Contenu dynamique selon le champ sélectionné -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Justification -->
            <div class="space-y-6 mb-8">
                <h3 class="font-serif text-lg font-semibold text-gray-900 flex items-center gap-2 pb-2 border-b border-gray-200">
                    <i data-feather="message-square" class="w-5 h-5 text-brand-primary"></i>
                    Justification
                </h3>
                
                <div>
                    <label for="{{ form.justification.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                        Pourquoi proposez-vous cette modification ? *
                    </label>
                    {{ form.justification }}
                    {% if form.justification.errors %}
                        <div class="mt-1 text-sm text-red-600 flex items-center gap-1">
                            <i data-feather="alert-circle" class="w-4 h-4"></i>
                            {{ form.justification.errors.0 }}
                        </div>
                    {% endif %}
                    <p class="mt-1 text-xs text-gray-500">
                        Expliquez les raisons de votre proposition : source d'information, erreur constatée, 
                        informations complémentaires, etc.
                    </p>
                    
                    <!-- Suggestions de justification -->
                    <div class="mt-3 space-y-2">
                        <p class="text-xs font-medium text-gray-700">Exemples de bonnes justifications :</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-xs">
                            <button type="button" onclick="addJustificationExample(this)" class="text-left p-2 bg-gray-50 rounded border hover:bg-gray-100 transition">
                                "D'après l'acte de naissance que je possède..."
                            </button>
                            <button type="button" onclick="addJustificationExample(this)" class="text-left p-2 bg-gray-50 rounded border hover:bg-gray-100 transition">
                                "Témoignage de la famille confirmant que..."
                            </button>
                            <button type="button" onclick="addJustificationExample(this)" class="text-left p-2 bg-gray-50 rounded border hover:bg-gray-100 transition">
                                "Erreur dans la date, la bonne date est..."
                            </button>
                            <button type="button" onclick="addJustificationExample(this)" class="text-left p-2 bg-gray-50 rounded border hover:bg-gray-100 transition">
                                "Information manquante que je souhaite ajouter..."
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Comparaison avant/après -->
            <div class="space-y-6 mb-8">
                <h3 class="font-serif text-lg font-semibold text-gray-900 flex items-center gap-2 pb-2 border-b border-gray-200">
                    <i data-feather="compare" class="w-5 h-5 text-brand-primary"></i>
                    Aperçu des changements
                </h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Avant -->
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <div class="flex items-center gap-2 mb-3">
                            <i data-feather="minus" class="w-4 h-4 text-red-600"></i>
                            <span class="font-medium text-red-800">Valeur actuelle</span>
                        </div>
                        <div class="text-sm text-red-700" id="before-value">
                            <em class="text-red-400">Sélectionnez un champ</em>
                        </div>
                    </div>
                    
                    <!-- Après -->
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <div class="flex items-center gap-2 mb-3">
                            <i data-feather="plus" class="w-4 h-4 text-green-600"></i>
                            <span class="font-medium text-green-800">Nouvelle valeur</span>
                        </div>
                        <div class="text-sm text-green-700" id="after-value">
                            <em class="text-green-400">Saisissez la nouvelle valeur</em>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Messages d'erreur non-field -->
            {% if form.non_field_errors %}
            <div class="mb-6 bg-red-50 border border-red-200 rounded-lg p-4">
                <div class="flex items-center gap-2 text-red-800 font-medium mb-2">
                    <i data-feather="alert-triangle" class="w-4 h-4"></i>
                    Erreurs de validation
                </div>
                {% for error in form.non_field_errors %}
                <p class="text-sm text-red-700">{{ error }}</p>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Boutons d'action -->
            <div class="flex gap-4 pt-6 border-t border-gray-200">
                <button type="submit" class="bg-brand-primary text-white px-8 py-3 rounded-lg font-medium hover:bg-green-800 transition flex items-center gap-2" id="submitButton">
                    <span id="submitText">Envoyer la proposition</span>
                    <i data-feather="send" class="w-4 h-4" id="submitIcon"></i>
                    <div class="hidden animate-spin rounded-full h-4 w-4 border-b-2 border-white" id="submitSpinner"></div>
                </button>
                
                <a href="{% url 'genealogy:person_detail' person.id %}" 
                   class="bg-gray-100 text-gray-700 px-8 py-3 rounded-lg font-medium hover:bg-gray-200 transition flex items-center gap-2">
                    <i data-feather="x" class="w-4 h-4"></i>
                    Annuler
                </a>
            </div>
        </form>
    </div>
</div>

<script>
// Données de la personne pour afficher les valeurs actuelles
const personData = {
    'first_name': '{{ person.first_name|default:"Non renseigné" }}',
    'last_name': '{{ person.last_name|default:"Non renseigné" }}',
    'maiden_name': '{{ person.maiden_name|default:"Non renseigné" }}',
    'birth_date': '{% if person.birth_date %}{{ person.birth_date|date:"d/m/Y" }}{% else %}Non renseigné{% endif %}',
    'birth_place': '{{ person.birth_place|default:"Non renseigné" }}',
    'death_date': '{% if person.death_date %}{{ person.death_date|date:"d/m/Y" }}{% else %}Non renseigné{% endif %}',
    'death_place': '{{ person.death_place|default:"Non renseigné" }}',
    'profession': '{{ person.profession|default:"Non renseigné" }}',
    'biography': '{{ person.biography|truncatechars:100|default:"Non renseigné" }}'
};

// Aide contextuelle pour chaque champ
const fieldHelp = {
    'birth_date': 'Format recommandé : JJ/MM/AAAA (ex: 15/03/1985)',
    'death_date': 'Format recommandé : JJ/MM/AAAA (ex: 22/12/2020)',
    'birth_place': 'Soyez précis : ville, pays (ex: Kigali, Rwanda)',
    'death_place': 'Lieu du décès : ville, pays ou établissement',
    'biography': 'Rédigez quelques phrases sur la vie de cette personne',
    'profession': 'Profession principale ou activité connue'
};

// Mise à jour des valeurs actuelles et de l'aide
document.getElementById('{{ form.field_name.id_for_label }}').addEventListener('change', function() {
    const fieldName = this.value;
    const currentValueDiv = document.getElementById('current-value');
    const beforeValueDiv = document.getElementById('before-value');
    const helpDiv = document.getElementById('field-help');
    
    if (fieldName && personData[fieldName]) {
        // Afficher la valeur actuelle
        currentValueDiv.innerHTML = `<strong>${personData[fieldName]}</strong>`;
        beforeValueDiv.innerHTML = `<strong>${personData[fieldName]}</strong>`;
        
        // Afficher l'aide contextuelle
        if (fieldHelp[fieldName]) {
            helpDiv.querySelector('.text-yellow-800').innerHTML = `
                <i data-feather="lightbulb" class="w-4 h-4 inline mr-1"></i>
                <strong>Conseil :</strong> ${fieldHelp[fieldName]}
            `;
            helpDiv.classList.remove('hidden');
            feather.replace();
        } else {
            helpDiv.classList.add('hidden');
        }
    } else {
        currentValueDiv.innerHTML = '<em class="text-gray-400">Sélectionnez un champ pour voir la valeur actuelle</em>';
        beforeValueDiv.innerHTML = '<em class="text-red-400">Sélectionnez un champ</em>';
        helpDiv.classList.add('hidden');
    }
    
    // Réinitialiser l'aperçu de la nouvelle valeur
    document.getElementById('after-value').innerHTML = '<em class="text-green-400">Saisissez la nouvelle valeur</em>';
});

// Mise à jour de l'aperçu de la nouvelle valeur
document.getElementById('{{ form.new_value.id_for_label }}').addEventListener('input', function() {
    const afterValueDiv = document.getElementById('after-value');
    
    if (this.value.trim()) {
        afterValueDiv.innerHTML = `<strong>${this.value}</strong>`;
    } else {
        afterValueDiv.innerHTML = '<em class="text-green-400">Saisissez la nouvelle valeur</em>';
    }
});

// Ajouter un exemple de justification
function addJustificationExample(button) {
    const textarea = document.getElementById('{{ form.justification.id_for_label }}');
    const example = button.textContent;
    
    if (textarea.value.trim()) {
        textarea.value += '\n\n' + example;
    } else {
        textarea.value = example;
    }
    
    textarea.focus();
    textarea.setSelectionRange(textarea.value.length, textarea.value.length);
}

// Form submission loading state
document.getElementById('proposalForm').addEventListener('submit', function(e) {
    // Validation simple
    const fieldName = document.getElementById('{{ form.field_name.id_for_label }}').value;
    const newValue = document.getElementById('{{ form.new_value.id_for_label }}').value.trim();
    const justification = document.getElementById('{{ form.justification.id_for_label }}').value.trim();
    
    if (!fieldName || !newValue || !justification) {
        e.preventDefault();
        alert('Veuillez remplir tous les champs obligatoires.');
        return;
    }
    
    if (justification.length < 10) {
        e.preventDefault();
        alert('La justification doit être plus détaillée (au moins 10 caractères).');
        return;
    }
    
    // Loading state
    const button = document.getElementById('submitButton');
    const text = document.getElementById('submitText');
    const icon = document.getElementById('submitIcon');
    const spinner = document.getElementById('submitSpinner');
    
    button.disabled = true;
    text.textContent = 'Envoi en cours...';
    icon.classList.add('hidden');
    spinner.classList.remove('hidden');
});

// Initialisation
document.addEventListener('DOMContentLoaded', function() {
    // Déclencher la mise à jour si un champ est déjà sélectionné
    const fieldSelect = document.getElementById('{{ form.field_name.id_for_label }}');
    if (fieldSelect.value) {
        fieldSelect.dispatchEvent(new Event('change'));
    }
});
</script>

{% endblock %}