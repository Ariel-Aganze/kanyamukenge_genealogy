{% extends 'base/base.html' %}
{% load static %}
{% load notifications_tags %}

{% block body %}
<div class="bg-brand-bg text-brand-text font-sans antialiased h-screen flex overflow-hidden">

    <!-- SIDEBAR (Fixe à gauche) -->
    <aside class="w-64 bg-brand-primary text-white flex-shrink-0 hidden md:flex flex-col shadow-2xl z-20">
        
        <!-- Header Sidebar -->
        <div class="p-6 border-b border-white/10">
            <h1 class="font-serif text-xl font-bold tracking-wide text-center leading-tight">
                Famille<br>KANYAMUKENGE
            </h1>
            <!-- <p class="text-green-200/60 text-xs text-center mt-2 uppercase tracking-widest">Administration</p> -->
        </div>

        <!-- Navigation -->
        <nav class="flex-1 overflow-y-auto py-6 px-3 space-y-1">
            
            <!-- Groupe : Principal -->
            <p class="px-3 text-xs font-medium text-green-300/70 uppercase tracking-wider mb-2 mt-2">Vue d'ensemble</p>
            
            <a href="{% url 'genealogy:dashboard' %}" class="group flex items-center px-3 py-3 text-sm font-medium rounded-lg {% if request.resolver_match.url_name == 'dashboard' %}bg-white/10 text-white{% else %}text-green-100 hover:bg-white/5 hover:text-white{% endif %} transition">
                <i data-feather="layout" class="mr-3 h-5 w-5 {% if request.resolver_match.url_name == 'dashboard' %}text-brand-accent{% else %}opacity-70{% endif %}"></i>
                Tableau de bord
            </a>
            
            <a href="{% url 'genealogy:family_tree' %}" class="group flex items-center px-3 py-3 text-sm font-medium rounded-lg {% if 'family_tree' in request.resolver_match.url_name %}bg-white/10 text-white{% else %}text-green-100 hover:bg-white/5 hover:text-white{% endif %} transition">
                <i data-feather="share-2" class="mr-3 h-5 w-5 {% if 'family_tree' in request.resolver_match.url_name %}text-brand-accent{% else %}opacity-70{% endif %}"></i>
                Visualiser l'Arbre
            </a>

            <!-- Notifications -->
            <a href="{% url 'genealogy:notifications' %}" class="group flex items-center px-3 py-3 text-sm font-medium rounded-lg {% if request.resolver_match.url_name == 'notifications' %}bg-white/10 text-white{% else %}text-green-100 hover:bg-white/5 hover:text-white{% endif %} transition relative">
                <i data-feather="bell" class="mr-3 h-5 w-5 {% if request.resolver_match.url_name == 'notifications' %}text-brand-accent{% else %}opacity-70{% endif %}"></i>
                Notifications
                <!-- Notification badge with fallback -->
                {% get_unread_notifications_count user as notification_count %}
                {% if notification_count > 0 %}
                <span class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full min-w-[1.25rem] h-5 flex items-center justify-center font-medium">
                    {% if notification_count > 99 %}99+{% else %}{{ notification_count }}{% endif %}
                </span>
                {% endif %}
            </a>

            <!-- Groupe : Gestion -->
            <p class="px-3 text-xs font-medium text-green-300/70 uppercase tracking-wider mb-2 mt-6">Registre Familial</p>
            
            <a href="{% url 'genealogy:search' %}" class="group flex items-center px-3 py-3 text-sm font-medium rounded-lg {% if request.resolver_match.url_name == 'search' %}bg-white/10 text-white{% else %}text-green-100 hover:bg-white/5 hover:text-white{% endif %} transition">
                <i data-feather="users" class="mr-3 h-5 w-5 {% if request.resolver_match.url_name == 'search' %}text-brand-accent{% else %}opacity-70{% endif %}"></i>
                Membres de la famille
            </a>
            
            <a href="{% url 'genealogy:person_create' %}" class="group flex items-center px-3 py-3 text-sm font-medium rounded-lg {% if request.resolver_match.url_name == 'person_create' %}bg-white/10 text-white{% else %}text-green-100 hover:bg-white/5 hover:text-white{% endif %} transition">
                <i data-feather="user-plus" class="mr-3 h-5 w-5 {% if request.resolver_match.url_name == 'person_create' %}text-brand-accent{% else %}opacity-70{% endif %}"></i>
                Ajouter un membre
            </a>
            
            {% if user.role == 'admin' %}
            <!-- Propositions -->
            <a href="{% url 'genealogy:manage_users' %}?tab=proposals" class="group flex items-center px-3 py-3 text-sm font-medium rounded-lg {% if request.resolver_match.url_name == 'manage_users' and 'proposals' in request.GET.tab %}bg-white/10 text-white{% else %}text-green-100 hover:bg-white/5 hover:text-white{% endif %} transition">
                <i data-feather="git-pull-request" class="mr-3 h-5 w-5 {% if request.resolver_match.url_name == 'manage_users' and 'proposals' in request.GET.tab %}text-brand-accent{% else %}opacity-70{% endif %}"></i>
                Propositions
                {% load propositions_tags %}
                {% get_pending_proposals_count as pending_count %}
                {% if pending_count > 0 %}
                <span class="ml-auto bg-brand-accent text-white py-0.5 px-2 rounded-full text-xs">{{ pending_count }}</span>
                {% endif %}
            </a>
            {% endif %}

            <!-- Groupe : Système -->
            {% if user.role == 'admin' %}
            <p class="px-3 text-xs font-medium text-green-300/70 uppercase tracking-wider mb-2 mt-6">Configuration</p>
            
            <a href="{% url 'genealogy:manage_users' %}" class="group flex items-center px-3 py-3 text-sm font-medium rounded-lg {% if request.resolver_match.url_name == 'manage_users' and not request.GET.tab %}bg-white/10 text-white{% else %}text-green-100 hover:bg-white/5 hover:text-white{% endif %} transition">
                <i data-feather="shield" class="mr-3 h-5 w-5 {% if request.resolver_match.url_name == 'manage_users' and not request.GET.tab %}text-brand-accent{% else %}opacity-70{% endif %}"></i>
                Utilisateurs & Accès
            </a>
            
            <a href="{% url 'genealogy:audit_log' %}" class="group flex items-center px-3 py-3 text-sm font-medium rounded-lg {% if request.resolver_match.url_name == 'audit_log' %}bg-white/10 text-white{% else %}text-green-100 hover:bg-white/5 hover:text-white{% endif %} transition">
                <i data-feather="file-text" class="mr-3 h-5 w-5 {% if request.resolver_match.url_name == 'audit_log' %}text-brand-accent{% else %}opacity-70{% endif %}"></i>
                Journal d'audit
            </a>
            
            <a href="#" class="group flex items-center px-3 py-3 text-sm font-medium rounded-lg text-green-100 hover:bg-white/5 hover:text-white transition" onclick="showGedcomModal()">
                <i data-feather="download" class="mr-3 h-5 w-5 opacity-70"></i>
                Export GEDCOM
            </a>
            {% endif %}
            
            <!-- Groupe : Profil -->
            <p class="px-3 text-xs font-medium text-green-300/70 uppercase tracking-wider mb-2 mt-6">Profil</p>
            
            <a href="{% url 'accounts:profile' %}" class="group flex items-center px-3 py-3 text-sm font-medium rounded-lg {% if request.resolver_match.url_name == 'profile' %}bg-white/10 text-white{% else %}text-green-100 hover:bg-white/5 hover:text-white{% endif %} transition">
                <i data-feather="user" class="mr-3 h-5 w-5 {% if request.resolver_match.url_name == 'profile' %}text-brand-accent{% else %}opacity-70{% endif %}"></i>
                Mon profil
            </a>
            
            <form method="post" action="{% url 'accounts:logout' %}">
                {% csrf_token %}
                <button type="submit" class="w-full group flex items-center px-3 py-3 text-sm font-medium rounded-lg text-green-100 hover:bg-white/5 hover:text-white transition">
                    <i data-feather="log-out" class="mr-3 h-5 w-5 opacity-70"></i>
                    Se déconnecter
                </button>
            </form>
        </nav>
        
        <!-- Profile Footer -->
        <div class="p-4 border-t border-white/10">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-gradient-to-br from-brand-accent to-amber-600 rounded-full flex items-center justify-center text-white font-bold text-sm">
                    {{ user.first_name.0|default:'U' }}{{ user.last_name.0|default:'U' }}
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium text-white truncate">{{ user.get_full_name }}</p>
                    <p class="text-xs text-green-300/70 capitalize">{{ user.get_role_display }}</p>
                </div>
            </div>
        </div>
    </aside>

    <!-- MOBILE SIDEBAR OVERLAY -->
    <div id="mobile-sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>
    
    <!-- MOBILE SIDEBAR -->
    <aside id="mobile-sidebar" class="fixed left-0 top-0 w-64 h-full bg-brand-primary text-white z-40 transform -translate-x-full transition-transform duration-300 md:hidden">
        
        <!-- Header Sidebar Mobile -->
        <div class="p-6 border-b border-white/10 flex items-center justify-between">
            <div class="text-center flex-1">
                <h1 class="font-serif text-xl font-bold tracking-wide leading-tight">
                    Famille<br>KANYAMUKENGE
                </h1>
                <p class="text-green-200/60 text-xs mt-2 uppercase tracking-widest">Administration</p>
            </div>
            <button id="mobile-menu-close" class="p-2 rounded-lg hover:bg-white/10 transition ml-4">
                <i data-feather="x" class="w-5 h-5"></i>
            </button>
        </div>

        <!-- Navigation Mobile -->
        <nav class="flex-1 overflow-y-auto py-6 px-3 space-y-1">
            
            <!-- Groupe : Principal -->
            <p class="px-3 text-xs font-medium text-green-300/70 uppercase tracking-wider mb-2 mt-2">Vue d'ensemble</p>
            
            <a href="{% url 'genealogy:dashboard' %}" class="mobile-nav-link group flex items-center px-3 py-3 text-sm font-medium rounded-lg {% if request.resolver_match.url_name == 'dashboard' %}bg-white/10 text-white{% else %}text-green-100 hover:bg-white/5 hover:text-white{% endif %} transition">
                <i data-feather="layout" class="mr-3 h-5 w-5 {% if request.resolver_match.url_name == 'dashboard' %}text-brand-accent{% else %}opacity-70{% endif %}"></i>
                Tableau de bord
            </a>
            
            <a href="{% url 'genealogy:family_tree' %}" class="mobile-nav-link group flex items-center px-3 py-3 text-sm font-medium rounded-lg {% if 'family_tree' in request.resolver_match.url_name %}bg-white/10 text-white{% else %}text-green-100 hover:bg-white/5 hover:text-white{% endif %} transition">
                <i data-feather="share-2" class="mr-3 h-5 w-5 {% if 'family_tree' in request.resolver_match.url_name %}text-brand-accent{% else %}opacity-70{% endif %}"></i>
                Visualiser l'Arbre
            </a>

            <!-- Notifications Mobile -->
            <a href="{% url 'genealogy:notifications' %}" class="mobile-nav-link group flex items-center px-3 py-3 text-sm font-medium rounded-lg {% if request.resolver_match.url_name == 'notifications' %}bg-white/10 text-white{% else %}text-green-100 hover:bg-white/5 hover:text-white{% endif %} transition relative">
                <i data-feather="bell" class="mr-3 h-5 w-5 {% if request.resolver_match.url_name == 'notifications' %}text-brand-accent{% else %}opacity-70{% endif %}"></i>
                Notifications
                <!-- Notification badge with fallback -->
                {% get_unread_notifications_count user as notification_count %}
                {% if notification_count > 0 %}
                <span class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full min-w-[1.25rem] h-5 flex items-center justify-center font-medium">
                    {% if notification_count > 99 %}99+{% else %}{{ notification_count }}{% endif %}
                </span>
                {% endif %}
            </a>

            <!-- Groupe : Gestion -->
            <p class="px-3 text-xs font-medium text-green-300/70 uppercase tracking-wider mb-2 mt-6">Registre Familial</p>
            
            <a href="{% url 'genealogy:search' %}" class="mobile-nav-link group flex items-center px-3 py-3 text-sm font-medium rounded-lg {% if request.resolver_match.url_name == 'search' %}bg-white/10 text-white{% else %}text-green-100 hover:bg-white/5 hover:text-white{% endif %} transition">
                <i data-feather="users" class="mr-3 h-5 w-5 {% if request.resolver_match.url_name == 'search' %}text-brand-accent{% else %}opacity-70{% endif %}"></i>
                Membres de la famille
            </a>
            
            <a href="{% url 'genealogy:person_create' %}" class="mobile-nav-link group flex items-center px-3 py-3 text-sm font-medium rounded-lg {% if request.resolver_match.url_name == 'person_create' %}bg-white/10 text-white{% else %}text-green-100 hover:bg-white/5 hover:text-white{% endif %} transition">
                <i data-feather="user-plus" class="mr-3 h-5 w-5 {% if request.resolver_match.url_name == 'person_create' %}text-brand-accent{% else %}opacity-70{% endif %}"></i>
                Ajouter un membre
            </a>
            
            {% if user.role == 'admin' %}
            <!-- Propositions Mobile -->
            <a href="{% url 'genealogy:manage_users' %}?tab=proposals" class="mobile-nav-link group flex items-center px-3 py-3 text-sm font-medium rounded-lg {% if request.resolver_match.url_name == 'manage_users' and 'proposals' in request.GET.tab %}bg-white/10 text-white{% else %}text-green-100 hover:bg-white/5 hover:text-white{% endif %} transition">
                <i data-feather="git-pull-request" class="mr-3 h-5 w-5 {% if request.resolver_match.url_name == 'manage_users' and 'proposals' in request.GET.tab %}text-brand-accent{% else %}opacity-70{% endif %}"></i>
                Propositions
                {% load propositions_tags %}
                {% get_pending_proposals_count as pending_count %}
                {% if pending_count > 0 %}
                <span class="ml-auto bg-brand-accent text-white py-0.5 px-2 rounded-full text-xs">{{ pending_count }}</span>
                {% endif %}
            </a>
            {% endif %}

            <!-- Groupe : Système -->
            {% if user.role == 'admin' %}
            <p class="px-3 text-xs font-medium text-green-300/70 uppercase tracking-wider mb-2 mt-6">Configuration</p>
            
            <a href="{% url 'genealogy:manage_users' %}" class="mobile-nav-link group flex items-center px-3 py-3 text-sm font-medium rounded-lg {% if request.resolver_match.url_name == 'manage_users' and not request.GET.tab %}bg-white/10 text-white{% else %}text-green-100 hover:bg-white/5 hover:text-white{% endif %} transition">
                <i data-feather="shield" class="mr-3 h-5 w-5 {% if request.resolver_match.url_name == 'manage_users' and not request.GET.tab %}text-brand-accent{% else %}opacity-70{% endif %}"></i>
                Utilisateurs & Accès
            </a>
            
            <a href="{% url 'genealogy:audit_log' %}" class="mobile-nav-link group flex items-center px-3 py-3 text-sm font-medium rounded-lg {% if request.resolver_match.url_name == 'audit_log' %}bg-white/10 text-white{% else %}text-green-100 hover:bg-white/5 hover:text-white{% endif %} transition">
                <i data-feather="file-text" class="mr-3 h-5 w-5 {% if request.resolver_match.url_name == 'audit_log' %}text-brand-accent{% else %}opacity-70{% endif %}"></i>
                Journal d'audit
            </a>
            
            <a href="#" class="mobile-nav-link group flex items-center px-3 py-3 text-sm font-medium rounded-lg text-green-100 hover:bg-white/5 hover:text-white transition" onclick="showGedcomModal()">
                <i data-feather="download" class="mr-3 h-5 w-5 opacity-70"></i>
                Export GEDCOM
            </a>
            {% endif %}
            
            <!-- Groupe : Profil -->
            <p class="px-3 text-xs font-medium text-green-300/70 uppercase tracking-wider mb-2 mt-6">Profil</p>
            
            <a href="{% url 'accounts:profile' %}" class="mobile-nav-link group flex items-center px-3 py-3 text-sm font-medium rounded-lg {% if request.resolver_match.url_name == 'profile' %}bg-white/10 text-white{% else %}text-green-100 hover:bg-white/5 hover:text-white{% endif %} transition">
                <i data-feather="user" class="mr-3 h-5 w-5 {% if request.resolver_match.url_name == 'profile' %}text-brand-accent{% else %}opacity-70{% endif %}"></i>
                Mon profil
            </a>
            
            <form method="post" action="{% url 'accounts:logout' %}">
                {% csrf_token %}
                <button type="submit" class="w-full group flex items-center px-3 py-3 text-sm font-medium rounded-lg text-green-100 hover:bg-white/5 hover:text-white transition">
                    <i data-feather="log-out" class="mr-3 h-5 w-5 opacity-70"></i>
                    Se déconnecter
                </button>
            </form>
        </nav>
        
        <!-- Profile Footer Mobile -->
        <div class="p-4 border-t border-white/10">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-gradient-to-br from-brand-accent to-amber-600 rounded-full flex items-center justify-center text-white font-bold text-sm">
                    {{ user.first_name.0|default:'U' }}{{ user.last_name.0|default:'U' }}
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium text-white truncate">{{ user.get_full_name }}</p>
                    <p class="text-xs text-green-300/70 capitalize">{{ user.get_role_display }}</p>
                </div>
            </div>
        </div>
    </aside>

    <!-- CONTENU PRINCIPAL (Zone défilante) -->
    <main class="flex-1 flex flex-col overflow-hidden bg-brand-bg">
        
        <!-- Header Top (Mobile + Actions) -->
        <header class="bg-white border-b border-brand-border px-6 py-4 flex items-center justify-between shadow-sm">
            
            <!-- Menu Mobile (burger) + Titre dynamique -->
            <div class="flex items-center gap-4">
                <button id="mobile-menu-toggle" class="md:hidden p-2 rounded-lg hover:bg-gray-100 transition">
                    <i data-feather="menu" class="w-6 h-6 text-gray-600"></i>
                </button>
                
                <!-- Titre de la page dans le header -->
                <h1 class="hidden md:block font-serif text-xl font-bold text-brand-primary">
                    {% if request.resolver_match.url_name == 'dashboard' %}
                        Tableau de Bord
                    {% elif 'family_tree' in request.resolver_match.url_name %}
                        Arbre Généalogique
                    {% elif request.resolver_match.url_name == 'search' %}
                        Recherche de Membres
                    {% elif request.resolver_match.url_name == 'person_create' %}
                        Ajouter un Membre
                    {% elif request.resolver_match.url_name == 'manage_users' %}
                        Gestion des Utilisateurs
                    {% elif request.resolver_match.url_name == 'audit_log' %}
                        Journal d'Audit
                    {% elif request.resolver_match.url_name == 'profile' %}
                        Mon Profil
                    {% elif request.resolver_match.url_name == 'notifications' %}
                        Notifications
                    {% elif request.resolver_match.url_name == 'review_proposal' %}
                        Examiner Proposition
                    {% elif 'person_detail' in request.resolver_match.url_name %}
                        Profil de {{ person.get_full_name|default:"Membre" }}
                    {% elif 'person_edit' in request.resolver_match.url_name %}
                        Modifier {{ person.get_full_name|default:"Membre" }}
                    {% else %}
                        {% block page_title %}Famille KANYAMUKENGE{% endblock %}
                    {% endif %}
                </h1>
            </div>
            
            <!-- Actions (Notifications + Profile) -->
            <div class="flex items-center gap-4">
                
                <!-- Profile dropdown fonctionnel -->
                <div class="relative">
                    <button id="profile-btn" class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-100 transition">
                        <div class="w-8 h-8 bg-gradient-to-br from-brand-primary to-green-700 rounded-full flex items-center justify-center text-white font-bold text-sm">
                            {{ user.first_name.0|default:'U' }}{{ user.last_name.0|default:'U' }}
                        </div>
                        <span class="hidden sm:block text-sm font-medium text-gray-700">{{ user.get_full_name }}</span>
                        <i data-feather="chevron-down" class="hidden sm:block w-4 h-4 text-gray-400"></i>
                    </button>
                    
                    <!-- Profile dropdown menu -->
                    <div id="profile-dropdown" class="absolute right-0 top-full mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 z-50 hidden">
                        <div class="p-3 border-b border-gray-100">
                            <p class="text-sm font-medium text-gray-900">{{ user.get_full_name }}</p>
                            <p class="text-xs text-gray-500">{{ user.email }}</p>
                        </div>
                        <div class="py-2">
                            <a href="{% url 'accounts:profile' %}" class="flex items-center gap-2 px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 transition">
                                <i data-feather="user" class="w-4 h-4"></i>
                                Mon profil
                            </a>
                        </div>
                        <div class="border-t border-gray-100 py-2">
                            <form method="post" action="{% url 'accounts:logout' %}" class="block">
                                {% csrf_token %}
                                <button type="submit" class="flex items-center gap-2 w-full px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 transition text-left">
                                    <i data-feather="log-out" class="w-4 h-4"></i>
                                    Se déconnecter
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- Zone de contenu scrollable -->
        <div class="flex-1 overflow-y-auto p-6">
            
            <!-- Messages Django (si présents) -->
            {% if messages %}
            <div class="mb-6 space-y-3">
                {% for message in messages %}
                <div class="alert-{{ message.tags }} px-4 py-3 rounded-lg border flex items-center gap-3
                    {% if message.tags == 'success' %}bg-green-50 border-green-200 text-green-800{% elif message.tags == 'error' %}bg-red-50 border-red-200 text-red-800{% elif message.tags == 'warning' %}bg-yellow-50 border-yellow-200 text-yellow-800{% else %}bg-blue-50 border-blue-200 text-blue-800{% endif %}">
                    <i data-feather="{% if message.tags == 'success' %}check-circle{% elif message.tags == 'error' %}alert-circle{% elif message.tags == 'warning' %}alert-triangle{% else %}info{% endif %}" class="w-5 h-5 flex-shrink-0"></i>
                    <span>{{ message }}</span>
                    <button class="ml-auto text-current opacity-70 hover:opacity-100" onclick="this.parentElement.style.display='none'">
                        <i data-feather="x" class="w-4 h-4"></i>
                    </button>
                </div>
                {% endfor %}
            </div>
            {% endif %}
            
            <!-- Contenu de la page -->
            {% block dashboard_content %}
            <!-- Contenu spécifique à chaque page -->
            {% endblock %}
        </div>
    </main>
</div>

<!-- Modal GEDCOM (si nécessaire) -->
<div id="gedcomModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl max-w-md w-full p-6">
        <div class="flex items-center gap-3 mb-4">
            <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                <i data-feather="download" class="w-6 h-6 text-green-600"></i>
            </div>
            <div>
                <h3 class="font-serif text-lg font-bold text-gray-900">Export GEDCOM</h3>
                <p class="text-sm text-gray-600">Télécharger l'arbre généalogique</p>
            </div>
        </div>
        
        <p class="text-gray-700 mb-6">
            Voulez-vous exporter l'intégralité de l'arbre généalogique au format GEDCOM ? 
            Ce fichier pourra être importé dans d'autres logiciels de généalogie.
        </p>
        
        <div class="flex gap-3">
            <a href="{% url 'genealogy:export_gedcom' %}" 
               class="flex-1 px-4 py-2 bg-brand-primary text-white rounded-lg hover:bg-green-800 transition text-center">
                Télécharger
            </a>
            <button onclick="hideGedcomModal()" 
                    class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition">
                Annuler
            </button>
        </div>
    </div>
</div>

<!-- JavaScript remains the same -->
<script>
// Remplacer les icônes Feather
document.addEventListener('DOMContentLoaded', function() {
    if (typeof feather !== 'undefined') {
        feather.replace();
    }
    
    // Initialize profile dropdown
    initializeDropdowns();
});

// Initialize dropdown functionality
function initializeDropdowns() {
    // Profile dropdown
    const profileBtn = document.getElementById('profile-btn');
    const profileDropdown = document.getElementById('profile-dropdown');
    
    if (profileBtn && profileDropdown) {
        profileBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            profileDropdown.classList.toggle('hidden');
        });
    }
    
    // Close dropdowns when clicking outside
    document.addEventListener('click', function() {
        if (profileDropdown) profileDropdown.classList.add('hidden');
    });
    
    // Prevent dropdown closing when clicking inside
    if (profileDropdown) {
        profileDropdown.addEventListener('click', function(e) {
            e.stopPropagation();
        });
    }
}

// Mobile Menu Management
document.getElementById('mobile-menu-toggle').addEventListener('click', function() {
    const sidebar = document.getElementById('mobile-sidebar');
    const overlay = document.getElementById('mobile-sidebar-overlay');
    
    sidebar.classList.remove('-translate-x-full');
    overlay.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
});

document.getElementById('mobile-menu-close').addEventListener('click', closeMobileMenu);
document.getElementById('mobile-sidebar-overlay').addEventListener('click', closeMobileMenu);

// Close mobile menu when clicking nav links
document.querySelectorAll('.mobile-nav-link').forEach(link => {
    link.addEventListener('click', closeMobileMenu);
});

function closeMobileMenu() {
    const sidebar = document.getElementById('mobile-sidebar');
    const overlay = document.getElementById('mobile-sidebar-overlay');
    
    sidebar.classList.add('-translate-x-full');
    overlay.classList.add('hidden');
    document.body.style.overflow = '';
}

// Modal GEDCOM
function showGedcomModal() {
    document.getElementById('gedcomModal').classList.remove('hidden');
}

function hideGedcomModal() {
    document.getElementById('gedcomModal').classList.add('hidden');
}

// Auto-hide alerts after 5 seconds
document.addEventListener('DOMContentLoaded', function() {
    const alerts = document.querySelectorAll('[class*="alert-"]');
    alerts.forEach(alert => {
        setTimeout(() => {
            alert.style.opacity = '0';
            setTimeout(() => alert.style.display = 'none', 300);
        }, 5000);
    });
});
</script>

{% endblock %}